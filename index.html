<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Scan for Google Sheet</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; }
        #status { margin-top: 20px; color: green; }
    </style>
</head>
<body>
    <h1>Scan NFC Tag to Log Data</h1>
    <p>Tap the button below, then bring the NFC tag close to your phone.</p>
    <button id="scanButton">Start NFC Scan</button>
    <div id="status"></div>

    <script>
        const scanButton = document.getElementById('scanButton');
        const statusDiv = document.getElementById('status');

        scanButton.addEventListener('click', async () => {
            if (!('NDEFReader' in window)) {
                statusDiv.textContent = 'Web NFC not supported in this browser.';
                return;
            }

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                statusDiv.textContent = 'Scanning for NFC tag...';

                ndef.onreading = event => {
                    const message = event.message;
                    let deviceId = '';

                    for (const record of message.records) {
                        if (record.recordType === 'text') {
                            const textDecoder = new TextDecoder(record.encoding);
                            deviceId = textDecoder.decode(record.data);
                            break;
                        }
                    }

                    if (!deviceId) {
                        statusDiv.textContent = 'No device ID found on tag.';
                        return;
                    }

                    const now = new Date();
                    const time = now.toLocaleTimeString();
                    const date = now.toLocaleDateString();

                    navigator.geolocation.getCurrentPosition(position => {
                        const gps = `${position.coords.latitude},${position.coords.longitude}`;
                        statusDiv.textContent = `Captured: Device ID=${deviceId}, Time=${time}, Date=${date}, GPS=${gps}. Logging...`;

                        // Send data to Apps Script to log in Sheet
                        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).logData(deviceId, time, date, gps);
                    }, error => {
                        statusDiv.textContent = 'GPS access denied: ' + error.message;
                    }, { enableHighAccuracy: true });
                };

                ndef.onreadingerror = () => {
                    statusDiv.textContent = 'Error reading NFC tag.';
                };
            } catch (error) {
                statusDiv.textContent = 'Scan failed: ' + error.message;
            }
        });

        function onSuccess(message) {
            statusDiv.textContent = message; // e.g., 'Data logged successfully!'
        }

        function onFailure(error) {
            statusDiv.textContent = 'Logging failed: ' + error;
        }
    </script>
</body>
</html>

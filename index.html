<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 10px 20px; font-size: 16px; }
    #status { margin-top: 20px; color: green; }
  </style>
</head>
<body>
  <h1>Log NFC Scan Data</h1>
  <p>Scan the NFC tag to open this page with device ID. Tap below to fetch and submit time, date, and GPS.</p>
  <button id="submitButton">Fetch and Submit Data</button>
  <div id="status"></div>

  <script>
    const deviceId = '<?= deviceId ?>';  // Device ID from NFC tag URL param
    const statusDiv = document.getElementById('status');
    const submitButton = document.getElementById('submitButton');

    submitButton.addEventListener('click', () => {
      statusDiv.textContent = 'Fetching data...';

      const now = new Date();
      const time = now.toLocaleTimeString();
      const date = now.toLocaleDateString();

      navigator.geolocation.getCurrentPosition(position => {
        const gps = `${position.coords.latitude},${position.coords.longitude}`;
        statusDiv.textContent = `Captured: Device ID=${deviceId}, Time=${time}, Date=${date}, GPS=${gps}. Submitting...`;

        const data = { deviceId, time, date, gps };
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).submitFormData(data);
      }, error => {
        statusDiv.textContent = 'GPS access denied: ' + error.message;
      }, { enableHighAccuracy: true });
    });

    function onSuccess(message) {
      statusDiv.textContent = message;
    }

    function onFailure(error) {
      statusDiv.textContent = 'Submission failed: ' + error;
    }
  </script>
</body>
</html>
